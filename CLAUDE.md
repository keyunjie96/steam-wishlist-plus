# CLAUDE.md - Project Context for AI Assistants

## Project Overview

**Steam Cross-Platform Wishlist** is a Chrome extension (Manifest V3) that displays platform availability icons (Nintendo Switch, PlayStation, Xbox, Steam Deck) and review scores on Steam wishlist pages using Wikidata, Steam's SSR data, and OpenCritic.

**Version:** 0.7.1
**Status:** Production-ready
**Tech Stack:** TypeScript, Chrome Extensions API (MV3), Jest

## Architecture

```
┌─────────────────────┐     chrome.runtime.sendMessage     ┌──────────────────────┐
│   Content Script    │ ──────────────────────────────────►│   Service Worker     │
│   (content.ts)      │                                    │   (background.ts)    │
│                     │ ◄──────────────────────────────────│                      │
│ - Extract appids    │     response with platform data    │ - Message routing    │
│ - Inject icons      │                                    │ - Cache coordination │
│ - Handle scroll     │                                    │                      │
└──────────┬──────────┘                                    └──────────┬───────────┘
           │                                                          │
   ┌───────▼───────────┐                                   ┌──────────▼───────────┐
   │ SteamDeckClient   │                                   │   Resolver           │
   │ (steamDeck        │                                   │   (resolver.ts)      │
   │  Client.ts)       │                                   │                      │
   │                   │                                   └──────────┬───────────┘
   │ - Inject Page     │                                              │
   │   Script          │                    ┌─────────────────────────┼──────────────────────────┬──────────────────────┐
   │ - Read DOM        │                    │                         │                          │                      │
   └───────┬───────────┘             ┌──────▼──────┐           ┌──────▼──────────┐       ┌──────▼──────┐       ┌────────▼──────────┐
           │                         │ Cache       │           │ WikidataClient  │       │ HltbClient  │       │ReviewScoresClient │
   ┌───────▼────────────┐            │ (cache.ts)  │           │ (wikidata       │       │ (hltb       │       │(reviewScores      │
   │ SteamDeckPageScript│            │             │           │  Client.ts)     │       │  Client.ts) │       │ Client.ts)        │
   │ (Injected Script)  │            └─────────────┘           └─────────────────┘       └─────────────┘       └───────────────────┘
   └────────────────────┘
```

## Directory Structure

```
├── manifest.json           # Extension manifest (MV3)
├── tsconfig.json           # TypeScript configuration
├── src/                    # TypeScript source files
│   ├── background.ts       # Service worker
│   ├── content.ts          # Content script
│   ├── cache.ts            # Cache module
│   ├── resolver.ts         # Resolution orchestrator
│   ├── wikidataClient.ts   # Wikidata SPARQL client
│   ├── hltbClient.ts       # HLTB completion time client
│   ├── hltbContent.ts      # HLTB content script (howlongtobeat.com)
│   ├── hltbPageScript.ts   # HLTB page script (MAIN world)
│   ├── reviewScoresClient.ts # OpenCritic review scores client
│   ├── steamDeckClient.ts  # Steam Deck data from page SSR
│   ├── steamDeckPageScript.ts # Injected script for SSR access
│   ├── icons.ts            # Icon definitions
│   ├── types.ts            # Type definitions
│   ├── options.ts          # Options page logic
│   ├── options.html        # Options page UI
│   └── styles.css          # Extension styles
├── dist/                   # Compiled JavaScript (generated by esbuild)
├── tests/                  # Test files
├── assets/icons/           # SVG source icons
└── scripts/                # Utility scripts
```

## Key Files

| File | Purpose | Critical Functions |
|------|---------|-------------------|
| `src/content.ts` | DOM manipulation, icon injection | `init()`, `processWishlistItems()`, `createPlatformIcon()`, `updateIconsWithData()` |
| `src/background.ts` | Service worker, message routing | Message handlers for `GET_PLATFORM_DATA`, `UPDATE_CACHE` |
| `src/resolver.ts` | Orchestrates data resolution | `resolvePlatformData()` |
| `src/cache.ts` | Chrome storage operations | `getFromCache()`, `saveToCache()`, `getOrCreatePlatformData()` |
| `src/wikidataClient.ts` | Wikidata SPARQL queries | `queryBySteamAppId()`, `executeSparqlQuery()` |
| `src/hltbClient.ts` | HLTB completion time queries | `queryByGameName()`, `batchQueryByGameNames()` |
| `src/hltbContent.ts` | HLTB content script bridge | `injectPageScript()`, message relay |
| `src/hltbPageScript.ts` | HLTB page script (MAIN world) | `searchHltb()`, `calculateSimilarity()` |
| `src/reviewScoresClient.ts` | OpenCritic review scores queries | `queryByGameName()`, `batchQueryByGameNames()`, `buildOpenCriticUrl()` |
| `src/steamDeckClient.ts` | Steam Deck data extraction | `waitForDeckData()`, `getDeckStatus()` |
| `src/steamDeckPageScript.ts` | Page script for SSR access | `extractDeckData()` (runs in MAIN world) |
| `src/icons.ts` | SVG icons and platform info | `PLATFORM_ICONS`, `PLATFORM_INFO`, `STATUS_INFO` |
| `src/types.ts` | TypeScript type definitions, URL builders | `StoreUrls.nintendo()`, `.playstation()`, `.xbox()` |

## Development Workflow

### Building
```bash
npm run build               # Compile TypeScript to dist/ (uses esbuild)
npm run typecheck           # Type check without emitting (uses tsc)
```

Note: esbuild compiles each file as a self-contained IIFE for Chrome extension compatibility.

### Running Tests
```bash
npm test                    # All tests
npm run test:unit           # Unit tests with coverage
npm run test:integration    # Integration tests (slow, ~5min)
npm run test:coverage       # Full coverage report
```

### Pre-Commit Testing Requirements

**IMPORTANT:** Before creating any commit, you MUST:

1. **Run unit tests**: `npm run test:unit`
2. **Verify all tests pass**: No test failures allowed
3. **Check coverage thresholds**: Coverage must meet or exceed thresholds in `jest.config.js`
4. **Add tests for new code**: Any new functions or branches need corresponding tests

If coverage thresholds are not met:
- Add more tests to cover the missing branches/lines
- Do NOT lower the coverage thresholds in `jest.config.js`
- Focus on testing error handling paths and edge cases

Current global thresholds:
- Branches: 75%
- Functions: 80%
- Lines: 80%
- Statements: 80%

### Version Updates

**When to update the version number:**
- **Patch version (0.5.x)**: Bug fixes, minor improvements, refactoring
- **Minor version (0.x.0)**: New features, significant enhancements
- **Major version (x.0.0)**: Breaking changes, major rewrites

**Files to update:**
1. `manifest.json` - `"version"` field
2. `package.json` - `"version"` field
3. `CLAUDE.md` - Version in Project Overview section
4. `src/hltbClient.ts` - User-Agent string (if version is referenced there)

**IMPORTANT:** Always update version numbers when making user-visible changes before creating a commit or PR.

### Loading the Extension
1. Run `npm run build` to compile TypeScript
2. Open `chrome://extensions/`
3. Enable "Developer mode"
4. Click "Load unpacked"
5. Select this folder

### Testing Changes
1. Make code changes in `src/*.ts`
2. Run `npm run build` (or use `npm run build:watch`)
3. Go to `chrome://extensions/`
4. Click refresh button on the extension
5. Navigate to a Steam wishlist page

## Key Concepts

### Icon States

**Console platforms (Nintendo/PlayStation/Xbox):**
- **available**: Full opacity, clickable - opens store page
- **unavailable**: Hidden (not displayed)
- **unknown**: Hidden (not displayed)

**Steam Deck:**
- **verified**: Full opacity (white icon), not clickable
- **playable**: Dimmed (35% opacity), not clickable
- **unsupported/unknown**: Hidden

### Resolution Priority
1. **Cache**: Check `chrome.storage.local` first (7-day TTL)
2. **Manual Overrides**: Hardcoded test data in `cache.ts`
3. **Wikidata**: SPARQL query for platform data
4. **Fallback**: Return "unknown" for all platforms

### Store URLs

**Direct Links (from Wikidata):** When Wikidata provides a store ID, the resolver validates the URL before caching:
1. Make HEAD request to check if URL is accessible
2. If valid (2xx/3xx) → use direct product link
3. If invalid (404/error) → fall back to US search URL

**Fallback URLs (when validation fails):**
- Nintendo: `https://www.nintendo.com/us/search/...`
- PlayStation: `https://store.playstation.com/en-us/search/...`
- Xbox: `https://www.xbox.com/en-US/search/...`

**Default Search URLs (no Wikidata store ID):**
- Nintendo: `https://www.nintendo.com/search/...` (region-agnostic)
- PlayStation: `https://store.playstation.com/search/...` (region-agnostic)
- Xbox: `https://www.xbox.com/search/...` (region-agnostic)

## Testing Data

Eight games have manual overrides in `cache.ts` for development testing.
**Note:** Overrides only work when `CACHE_DEBUG = true` in `src/cache.ts`.

| Appid | Game | NS | PS | XB |
|-------|------|----|----|-----|
| 367520 | Hollow Knight | ✓ | ✓ | ✓ |
| 1145360 | Hades | ✓ | ✓ | ✓ |
| 504230 | Celeste | ✓ | ✓ | ✓ |
| 413150 | Stardew Valley | ✓ | ✓ | ✓ |
| 632470 | Disco Elysium | ✓ | ✓ | ✓ |
| 1245620 | Elden Ring | ✗ | ✓ | ✓ |
| 1086940 | Baldur's Gate 3 | ✗ | ✓ | ✓ |
| 1091500 | Cyberpunk 2077 | ✗ | ✓ | ✓ |

## Code Conventions

- **Logging**: Use `[SCPW ...]` prefix for all console logs
- **Types**: TypeScript with strict mode enabled
- **Error Handling**: Graceful fallbacks, never crash the page
- **Privacy**: Wikidata queries for platform data, cache in local storage, no telemetry
- **Accessibility**: ARIA labels, focus states, reduced motion support
- **Build**: Source in `src/*.ts`, compiled to `dist/*.js` via esbuild (IIFE format)

## Protected Files

**Do NOT modify these files unless explicitly instructed by the user:**

- `jest.config.js` - Test configuration and coverage thresholds are intentionally set. If tests fail coverage thresholds, add more tests instead of lowering thresholds.

## Debug Flags

Each module has a debug flag at the top:
```typescript
const DEBUG = false;              // src/content.ts
const RESOLVER_DEBUG = false;     // src/resolver.ts
const WIKIDATA_DEBUG = false;     // src/wikidataClient.ts
const HLTB_DEBUG = false;         // src/hltbClient.ts
const CACHE_DEBUG = false;        // src/cache.ts (enables manual test overrides)
const STEAM_DECK_DEBUG = false;   // src/steamDeckClient.ts
const DEBUG = false;              // src/hltbContent.ts
const DEBUG = false;              // src/hltbPageScript.ts
const DEBUG = false;              // src/reviewScoresClient.ts
```

Set to `true` for verbose logging during development.

## Test Coverage Thresholds

| File | Lines | Functions |
|------|-------|-----------|
| src/cache.ts | 90% | 80% |
| src/resolver.ts | 90% | 100% |
| src/wikidataClient.ts | 90% | 90% |
| src/background.ts | 90% | 80% |
| src/options.ts | 100% | 100% |
| src/steamDeckClient.ts | 90% | 90% |

## Known Limitations

1. **Rate Limiting**: 500ms delay between Wikidata requests to avoid throttling
2. **Cache TTL**: 7 days - games that become available on new platforms won't update until cache expires
3. **Wikidata Coverage**: Not all games have platform data in Wikidata

## Browser Automation Testing (Playwright)

**IMPORTANT:** Playwright has significant limitations when testing Chrome extensions.

### What Playwright CAN Do

1. **Navigate to websites and observe results** - Load Steam wishlist pages to see if icons appear
2. **Test APIs directly on their websites** - Navigate to howlongtobeat.com and test their API from within the page context
3. **Scrape JavaScript to find API endpoints** - Fetch and analyze minified JS files to reverse-engineer API formats
4. **Read console logs** - Check browser_console_messages for extension log output
5. **Take screenshots** - Capture visual state of the page with extension icons

### What Playwright CANNOT Do

1. **Access extension service worker context** - The background script runs in an isolated world inaccessible from Playwright
2. **Inject into extension contexts** - Cannot directly call chrome.runtime.sendMessage or access extension storage
3. **Bypass CORS from page context** - API calls from browser_evaluate are subject to different CORS rules than the extension's host_permissions
4. **Test extension-to-extension messaging** - No way to simulate content script ↔ background worker communication

### Recommended Debugging Workflow

When an external API (like HLTB) stops working:

1. **Use Playwright to navigate to the API's website** (e.g., howlongtobeat.com)
2. **Scrape the JavaScript files** to find the current API endpoint and format:
   ```typescript
   // Example: Find API endpoint in minified JS
   const scripts = await page.evaluate(() =>
     Array.from(document.querySelectorAll('script[src]'))
       .map(s => s.src)
   );
   // Fetch each script and search for fetch() patterns
   ```
3. **Test the API directly using browser_evaluate**:
   ```typescript
   const result = await page.evaluate(async () => {
     const response = await fetch('/api/endpoint', { ... });
     return response.json();
   });
   ```
4. **Update the extension code** with the discovered format
5. **Verify manually** by loading the extension in Chrome and checking console logs

### API-Specific Notes

**HLTB (HowLongToBeat):**
- Uses an undocumented API that changes periodically
- Requires auth token from `/api/search/init?t=<timestamp>`
- Search endpoint: POST `/api/search` (not `/api/s/`)
- **Important:** Search API blocks non-browser requests (bot detection). Only works from real browser context (extension, Playwright). Node.js/undici requests get 404.
- Request body must include nested objects: `rangeTime`, `gameplay`, `rangeYear`, `users`, `lists`
- `searchTerms` must be `["Full Game Name"]` (single element), NOT split by spaces
- Response times are in **seconds**, divide by 3600 for hours
- Search alternatives: HLTB uses colons in series names (e.g., "Assassin's Creed: Unity"). The extension auto-tries colon variations at word boundaries.

**OpenCritic:**
- Search endpoint (`/api/game/search`) now requires an API key
- Game details endpoint (`/api/game/<id>`) still works without authentication
- The extension uses direct ID lookup via OpenCritic IDs from Wikidata, bypassing the search endpoint
- Review endpoint (`/api/review/game/<id>`) works without authentication

**Wikidata:**
- SPARQL queries are stable and well-documented
- Rate limit: 500ms between requests
- Can be tested directly via browser fetch
- Provides OpenCritic IDs (P2864) for direct game lookup

### Manual Extension Testing

For full end-to-end testing, use Chrome DevTools:
1. Load extension unpacked at `chrome://extensions/`
2. Navigate to Steam wishlist
3. Open DevTools → Console
4. Filter by `[SCPW` to see extension logs
5. Check Network tab for API requests from service worker

## Roadmap Maintenance

**IMPORTANT:** When completing bug fixes, features, or other items from `ROADMAP.md`:
1. Remove the completed item from its original section
2. Add it to the "Completed" section at the bottom
3. Remove it from the Priority Matrix table
4. Commit these changes alongside the fix

This ensures the roadmap stays current and future agents know what's been done.

## Future Roadmap Ideas

See `ROADMAP.md` for detailed specifications. Focus areas:
- **Console platform availability** (Nintendo/PS/Xbox) - core differentiator
- User preferences for platform visibility
- Steam Deck Verified status (implemented via SSR data)
- ChromeOS/Linux support via ProtonDB (potential future)
- Firefox/Edge browser support

Note: Features like price history, game notes, and wishlist categories were evaluated and declined - established extensions (Augmented Steam, SteamDB) already implement them well. See `ROADMAP.md` "Declined Features" section for details.

## Documentation Maintenance

**AI agents working on this project should actively maintain documentation:**

### ROADMAP.md Updates

1. **When you discover issues:** Add them to the appropriate section with:
   - Unique ID (e.g., `BUG-4`, `REL-2`)
   - Affected file(s)
   - Clear description and proposed fix

2. **When you complete items:** Move to "Completed" section with checkbox

3. **When you find improvements:** Add to "Ideas to Explore" or "Technical Debt"

4. **When you decline ideas:** Add to "Declined Features" with rationale

### CLAUDE.md Updates

Update this file when:
- Adding new files (update Directory Structure and Key Files tables)
- Adding new debug flags
- Changing architecture or key concepts
- Modifying icon states or resolution priority

### README.md Updates

Update when:
- Adding new platforms or features users should know about
- Changing icon behavior or states
- Modifying privacy-relevant permissions

**This proactive documentation ensures continuity across multiple agent sessions.**
